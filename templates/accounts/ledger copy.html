{% extends 'accounts/base.html' %}

{% block title %}دفتر الأستاذ - {{ account.code }} / General Ledger - {{ account.code }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>دفتر الأستاذ - {{ account.code }} / General Ledger - {{ account.code }}</h2>
    <div>
        <a href="?export=excel" class="btn btn-success">
            <i class="fas fa-file-excel"></i> تصدير Excel / Export Excel
        </a>
        <button onclick="window.print()" class="btn btn-outline-secondary">
            <i class="fas fa-print"></i> طباعة / Print
        </button>
        <a href="{{ account.get_absolute_url }}" class="btn btn-outline-primary">
            <i class="fas fa-eye"></i> تفاصيل الحساب / Account Details
        </a>
    </div>
</div>

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">لوحة التحكم / Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'accounts:chart_of_accounts' %}">دليل الحسابات / Chart of Accounts</a></li>
        <li class="breadcrumb-item"><a href="{{ account.get_absolute_url }}">{{ account.code }}</a></li>
        <li class="breadcrumb-item active">دفتر الأستاذ / Ledger</li>
    </ol>
</nav>

<div class="table-container">
    <div class="text-center mb-4">
        <h3>{{ account.code }} - {{ account.display_name }}</h3>
        <p class="text-muted">
            <span class="badge 
                {% if account.account_type == 'ASSET' %}bg-success
                {% elif account.account_type == 'LIABILITY' %}bg-warning
                {% elif account.account_type == 'EQUITY' %}bg-info
                {% elif account.account_type == 'REVENUE' %}bg-primary
                {% else %}bg-danger
                {% endif %}">
                {{ account.get_account_type_display }}
            </span>
        </p>
    </div>
    
    {% if transaction_data %}
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>التاريخ<br>Date</th>
                        <th>المرجع<br>Reference</th>
                        <th>الوصف<br>Description</th>
                        <th class="text-center">مدين<br>Debit</th>
                        <th class="text-center">دائن<br>Credit</th>
                        <th class="text-center">الرصيد<br>Balance</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Opening Balance Row -->
                    <tr class="table-light">
                        <td colspan="3"><strong>الرصيد الافتتاحي / Opening Balance</strong></td>
                        <td class="text-center">-</td>
                        <td class="text-center">-</td>
                        <td class="text-center"><strong>0.00</strong></td>
                    </tr>
                    
                    {% for item in transaction_data %}
                    <tr>
                        <td>{{ item.transaction.journal_entry.date }}</td>
                        <td>
                            <a href="{{ item.transaction.journal_entry.get_absolute_url }}" class="text-decoration-none">
                                {{ item.transaction.journal_entry.reference }}
                            </a>
                        </td>
                        <td>
                            {{ item.transaction.description|default:item.transaction.journal_entry.description }}
                        </td>
                        <td class="text-center">
                            {% if item.transaction.is_debit %}
                                <strong class="text-success">{{ item.transaction.amount|floatformat:2 }}</strong>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if not item.transaction.is_debit %}
                                <strong class="text-danger">{{ item.transaction.amount|floatformat:2 }}</strong>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <strong>{{ item.running_balance|floatformat:2 }}</strong>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-dark">
                    <tr>
                        <th colspan="3">الرصيد النهائي / Final Balance</th>
                        <th class="text-center">{{ account.get_debit_balance|floatformat:2 }}</th>
                        <th class="text-center">{{ account.get_credit_balance|floatformat:2 }}</th>
                        <th class="text-center">{{ account.get_net_balance|floatformat:2 }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ملخص الحساب / Account Summary</h5>
                        
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="border rounded p-3">
                                    <h6 class="text-muted">إجمالي المدين / Total Debits</h6>
                                    <div class="fs-4 fw-bold text-success">{{ account.get_debit_balance|floatformat:2 }}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-3">
                                    <h6 class="text-muted">إجمالي الدائن / Total Credits</h6>
                                    <div class="fs-4 fw-bold text-danger">{{ account.get_credit_balance|floatformat:2 }}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-3">
                                    <h6 class="text-muted">الرصيد الصافي / Net Balance</h6>
                                    <div class="fs-4 fw-bold text-primary">{{ account.get_net_balance|floatformat:2 }}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-3">
                                    <h6 class="text-muted">عدد المعاملات / Transaction Count</h6>
                                    <div class="fs-4 fw-bold text-info">{{ transaction_data|length }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>نوع الحساب / Account Type: {{ account.get_account_type_display }}</strong>
                                <br>
                                {% if account.account_type == 'ASSET' or account.account_type == 'EXPENSE' %}
                                    الرصيد الطبيعي: مدين / Natural Balance: Debit
                                {% else %}
                                    الرصيد الطبيعي: دائن / Natural Balance: Credit
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    {% else %}
        <div class="text-center text-muted py-5">
            <i class="fas fa-book-open fa-3x mb-3"></i>
            <h4>لا توجد معاملات / No Transactions Found</h4>
            <p>لم يتم تسجيل أي معاملات لهذا الحساب بعد</p>
            <p>No transactions have been recorded for this account yet</p>
            <a href="{% url 'accounts:journal_entry_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> إنشاء قيد جديد / Create New Entry
            </a>
        </div>
    {% endif %}
</div>

<style>
    @media print {
        .sidebar, .breadcrumb, .btn, nav {
            display: none !important;
        }
        
        .main-content {
            margin-right: 0 !important;
        }
        
        .table-container {
            box-shadow: none !important;
        }
        
        body {
            font-size: 12px;
        }
        
        .table th, .table td {
            padding: 0.5rem !important;
        }
    }
</style>
{% endblock %}
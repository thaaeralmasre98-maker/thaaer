{% extends 'accounts/base.html' %}

{% block title %}لوحة التحكم / Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>لوحة التحكم / Dashboard</h2>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item active">لوحة التحكم / Dashboard</li>
        </ol>
    </nav>
</div>

<div class="dashboard-cards">
    <div class="card">
        <div class="card-title">
            <i class="fas fa-wallet text-primary"></i>
            رصيد الصندوق / Fund Balance
        </div>
        <div class="card-value text-primary">{{ fund_balance|floatformat:2 }}</div>
        <div class="card-change">
            <small class="text-muted">النقدية والبنوك / Cash & Banks</small>
        </div>
    </div>
    
    <div class="card">
        <div class="card-title">
            <i class="fas fa-building text-success"></i>
            إجمالي الأصول المتداولة / Current Assets
        </div>
        <div class="card-value text-success">{{ current_assets|floatformat:2 }}</div>
        <div class="card-change">
            <small class="text-muted">الأصول السائلة / Liquid Assets</small>
        </div>
    </div>
    
    <div class="card">
        <div class="card-title">
            <i class="fas fa-hand-holding-usd text-warning"></i>
            سلف الموظفين / Employee Advances
        </div>
        <div class="card-value text-warning">{{ employee_advances|floatformat:2 }}</div>
        <div class="card-change">
            <small class="text-muted">السلف المستحقة / Outstanding Advances</small>
        </div>
    </div>
    
    <div class="card">
        <div class="card-title">
            <i class="fas fa-chart-line {% if net_income >= 0 %}text-success{% else %}text-danger{% endif %}"></i>
            صافي الدخل / Net Income
        </div>
        <div class="card-value {% if net_income >= 0 %}text-success{% else %}text-danger{% endif %}">
            {{ net_income|floatformat:2 }}
        </div>
        <div class="card-change">
            <small class="text-muted">الإيرادات - المصروفات / Revenue - Expenses</small>
        </div>
    </div>
</div>

<!-- Current Assets Breakdown -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-coins text-success"></i>
                    تفصيل الأصول المتداولة / Current Assets Breakdown
                </h5>
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-money-bill-wave fa-2x text-success mb-2"></i>
                                <h6 class="card-title">النقدية / Cash</h6>
                                <div class="fs-5 fw-bold text-success">{{ cash_amount|floatformat:2 }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-file-invoice-dollar fa-2x text-info mb-2"></i>
                                <h6 class="card-title">الذمم المدينة / A/R</h6>
                                <div class="fs-5 fw-bold text-info">{{ receivables_amount|floatformat:2 }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-boxes fa-2x text-warning mb-2"></i>
                                <h6 class="card-title">المخزون / Inventory</h6>
                                <div class="fs-5 fw-bold text-warning">{{ inventory_amount|floatformat:2 }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-hand-holding-usd fa-2x text-danger mb-2"></i>
                                <h6 class="card-title">السلف / Advances</h6>
                                <div class="fs-5 fw-bold text-danger">{{ advances_amount|floatformat:2 }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prepaid Revenues by Course -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-graduation-cap text-primary"></i>
                    الإيرادات المقدمة حسب الدورات / Prepaid Revenues by Course
                </h5>
                {% if prepaid_revenues %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>الدورة / Course</th>
                                    <th class="text-end">المبلغ / Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for revenue in prepaid_revenues %}
                                <tr>
                                    <td>{{ revenue.course_name }}</td>
                                    <td class="text-end">{{ revenue.balance|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">لا توجد إيرادات مقدمة / No prepaid revenues</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-pie text-info"></i>
                    إحصائيات الدورات / Course Statistics
                </h5>
                <div class="row text-center">
                    <div class="col-4">
                        <div class="border rounded p-2 mb-2">
                            <small class="text-muted">الدورات / Courses</small>
                            <div class="fw-bold text-primary">{{ total_courses }}</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2 mb-2">
                            <small class="text-muted">الطلاب / Students</small>
                            <div class="fw-bold text-success">{{ total_students }}</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2 mb-2">
                            <small class="text-muted">التسجيلات النشطة / Active Enrollments</small>
                            <div class="fw-bold text-warning">{{ active_enrollments }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-bolt text-primary"></i>
                    إجراءات سريعة / Quick Actions
                </h5>
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'accounts:journal_entry_create' %}" class="btn btn-primary btn-block w-100">
                            <i class="fas fa-plus-circle"></i>
                            قيد جديد / New Entry
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'accounts:account_create' %}" class="btn btn-success btn-block w-100">
                            <i class="fas fa-sitemap"></i>
                            حساب جديد / New Account
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'accounts:receipts_expenses' %}" class="btn btn-info btn-block w-100">
                            <i class="fas fa-receipt"></i>
                            إيصالات / Receipts
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'accounts:trial_balance' %}" class="btn btn-secondary btn-block w-100">
                            <i class="fas fa-balance-scale"></i>
                            ميزان المراجعة / Trial Balance
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Financial Overview Charts -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-pie text-primary"></i>
                    توزيع الأصول / Asset Distribution
                </h5>
                <div class="chart-container">
                    <canvas id="assetChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-bar text-success"></i>
                    الإيرادات مقابل المصروفات / Revenue vs Expenses
                </h5>
                <div class="chart-container">
                    <canvas id="revenueExpenseChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-title">
                <h5>آخر القيود / Recent Journal Entries</h5>
            </div>
            
            {% if recent_entries %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>المرجع / Reference</th>
                                <th>التاريخ / Date</th>
                                <th>الوصف / Description</th>
                                <th>المبلغ / Amount</th>
                                <th>الحالة / Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in recent_entries %}
                            <tr>
                                <td>
                                    <a href="{{ entry.get_absolute_url }}">{{ entry.reference }}</a>
                                </td>
                                <td>{{ entry.date }}</td>
                                <td>{{ entry.description|truncatechars:50 }}</td>
                                <td>{{ entry.total_amount|floatformat:2 }}</td>
                                <td>
                                    {% if entry.is_posted %}
                                        <span class="badge bg-success">مرحل / Posted</span>
                                    {% else %}
                                        <span class="badge bg-warning">غير مرحل / Unposted</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="text-center">
                    <a href="{% url 'accounts:journal_entry_list' %}" class="btn btn-outline-primary">
                        عرض جميع القيود / View All Entries
                    </a>
                </div>
            {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-book fa-3x mb-3"></i>
                    <p>لا توجد قيود يومية / No journal entries yet</p>
                    <a href="{% url 'accounts:journal_entry_create' %}" class="btn btn-primary">
                        إنشاء قيد جديد / Create New Entry
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-title">
                <h5>إحصائيات سريعة / Quick Stats</h5>
            </div>
            
            <div class="list-group list-group-flush">
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    عدد الحسابات / Total Accounts
                    <span class="badge bg-primary rounded-pill">{{ account_count }}</span>
                </div>
                
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    قيود غير مرحلة / Unposted Entries
                    <span class="badge bg-warning rounded-pill">{{ unposted_entries }}</span>
                </div>
                
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    إجمالي الإيرادات / Total Revenue
                    <span class="badge bg-success rounded-pill">{{ total_revenue|floatformat:2 }}</span>
                </div>
                
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    إجمالي المصروفات / Total Expenses
                    <span class="badge bg-danger rounded-pill">{{ total_expenses|floatformat:2 }}</span>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-title">
                <h5>روابط سريعة / Quick Links</h5>
            </div>
            
            <div class="d-grid gap-2">
                <a href="{% url 'accounts:journal_entry_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> قيد جديد / New Entry
                </a>
                
                <a href="{% url 'accounts:account_create' %}" class="btn btn-outline-primary">
                    <i class="fas fa-plus"></i> حساب جديد / New Account
                </a>
                
                <a href="{% url 'accounts:trial_balance' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-balance-scale"></i> ميزان المراجعة / Trial Balance
                </a>
                
                <a href="{% url 'accounts:reports' %}" class="btn btn-outline-info">
                    <i class="fas fa-chart-bar"></i> التقارير / Reports
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Performance Indicators -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-tachometer-alt text-info"></i>
                    مؤشرات الأداء / Performance Indicators
                </h5>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 text-primary">{{ current_ratio|floatformat:2 }}</div>
                            <small class="text-muted">نسبة التداول / Current Ratio</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 text-success">{{ profit_margin|floatformat:1 }}%</div>
                            <small class="text-muted">هامش الربح / Profit Margin</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 text-warning">{{ debt_ratio|floatformat:1 }}%</div>
                            <small class="text-muted">نسبة الدين / Debt Ratio</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 text-info">{{ working_capital|floatformat:0 }}</div>
                            <small class="text-muted">رأس المال العامل / Working Capital</small>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>نظام الاستحقاق المحاسبي / Accrual Accounting System</strong>
                        <br>
                        جميع العمليات تتم على أساس الاستحقاق مع تحديث تلقائي لأرصدة الحسابات الأب
                        <br>
                        <small>All operations are accrual-based with automatic parent account balance updates</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Asset Distribution Chart
const assetCtx = document.getElementById('assetChart').getContext('2d');
new Chart(assetCtx, {
    type: 'doughnut',
    data: {
        labels: ['Current Assets / الأصول المتداولة', 'Fixed Assets / الأصول الثابتة', 'Other / أخرى'],
        datasets: [{
            data: [{{ current_assets|default:0 }}, {{ fixed_assets|default:0 }}, {{ other_assets|default:0 }}],
            backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Revenue vs Expense Chart
const revenueCtx = document.getElementById('revenueExpenseChart').getContext('2d');
new Chart(revenueCtx, {
    type: 'bar',
    data: {
        labels: ['This Month / هذا الشهر', 'Last Month / الشهر الماضي'],
        datasets: [{
            label: 'Revenue / الإيرادات',
            data: [{{ current_month_revenue|default:0 }}, {{ last_month_revenue|default:0 }}],
            backgroundColor: '#36A2EB'
        }, {
            label: 'Expenses / المصروفات',
            data: [{{ current_month_expenses|default:0 }}, {{ last_month_expenses|default:0 }}],
            backgroundColor: '#FF6384'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>
{% endblock %}